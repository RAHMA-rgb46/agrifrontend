<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Farmers Q&A</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="hub.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
<div class="container-fluid">
    <div class="row make text-center m-2">
        <div class="col-12">
            <h3>Farmers Community</h3>
            <p>Share experiences and learn together</p>
        </div>
    </div>

    <div class="container make1 d-flex justify-content-between mt-3 align-items-center p-0 rounded-pill">
        <a href="story.html" class="btn quest w-50">Stories</a>
        <a href="hub.html" class="btn quest1 active w-50 rounded-pill">Q&A</a>
    </div>

    <div class="container-fluid mt-2">
        <div class="row d-flex justify-content-between align-items-center">
            <div class="col-6">
                <h6 class="ms-3">Questions & Answers</h6>
            </div>
            <div class="col-6 d-flex justify-content-end">
                <a href="ask.html">
                    <button type="button" class="btn btn-success"><i class="fa-solid fa-plus p-2"></i>Ask a Question</button>
                </a>
            </div>
        </div>
    </div>

    <div id="questionsContainer" class="container-fluid mt-3"></div>
</div>

<script>
const QUESTIONS_API = "http://localhost:5000/api/questions";
const ANSWERS_API = "http://localhost:5000/api/answers";

// Load all questions and their answers
async function loadQuestions() {
    const container = document.getElementById("questionsContainer");
    container.innerHTML = '';
    try {
        const res = await fetch(QUESTIONS_API);
        const questions = await res.json();

        questions.forEach(q => {
            const qDiv = document.createElement("div");
            qDiv.className = "form p-3 ms-3 mt-3 me-2";
            qDiv.innerHTML = `
                <p class="text-muted d-flex align-items-center mt-2">
                    <i class="fa-solid fa-circle-user text-success me-2 ms-3"></i>${q.authorName} â€¢ ${new Date(q.createdAt).toLocaleDateString()}
                </p>
                <h5 class="ms-5">${q.questionText}</h5>
                <div class="accordion accordion-flush mt-2" id="accordion-${q._id}"></div>
                <h6 class="text-muted mt-4">Add your answer</h6>
                <div class="form-floating mb-2">
                    <input type="text" id="author-${q._id}" placeholder="Your name" class="form-control">
                    <label for="author-${q._id}" class="oem-label">Your name</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" id="text-${q._id}" placeholder="Share your knowledge..." class="form-control">
                    <label for="text-${q._id}" class="oem-label">Share your knowledge...</label>
                </div>
                <button class="post btn btn-success mb-3" onclick="postAnswer('${q._id}')">Post Answer</button>
            `;
            container.appendChild(qDiv);

            loadAnswers(q._id);
        });

    } catch (err) {
        console.error("Error loading questions:", err);
    }
}

// Load answers for a question
async function loadAnswers(questionId) {
    try {
        const res = await fetch(`${ANSWERS_API}/${questionId}`);
        const answers = await res.json();

        const accordion = document.getElementById(`accordion-${questionId}`);
        accordion.innerHTML = answers.map(a => `
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${a._id}" aria-expanded="false">
                        Answer by ${a.authorName}
                    </button>
                </h2>
                <div id="collapse-${a._id}" class="accordion-collapse collapse" data-bs-parent="#accordion-${questionId}">
                    <div class="accordion-body">
                        <p>${a.answerText}</p>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (err) {
        console.error("Error loading answers:", err);
    }
}

// Post an answer
async function postAnswer(questionId) {
    const author = document.getElementById(`author-${questionId}`).value.trim();
    const text = document.getElementById(`text-${questionId}`).value.trim();

    if (!author || !text) {
        alert("Please fill in both fields.");
        return;
    }

    try {
        const res = await fetch(ANSWERS_API, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ questionId, authorName: author, answerText: text })
        });

        if (!res.ok) throw new Error("Failed to post answer");

        document.getElementById(`author-${questionId}`).value = "";
        document.getElementById(`text-${questionId}`).value = "";

        loadQuestions(); // reload questions & answers
    } catch (err) {
        console.error(err);
        alert("Error posting answer");
    }
}

// Initial load
loadQuestions();
</script>
</body>
</html>
